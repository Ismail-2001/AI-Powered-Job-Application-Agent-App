<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Profile | AI Job Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-600: #4F46E5;
            --primary-500: #6366F1;
            --gray-900: #111827;
            --gray-700: #374151;
            --gray-500: #6B7280;
            --gray-200: #E5E7EB;
            --white: #FFFFFF;
            --radius-lg: 0.75rem;
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #F9FAFB;
            color: var(--gray-900);
            margin: 0;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        p.subtitle {
            color: var(--gray-500);
            margin-bottom: 2rem;
        }

        .nav {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
        }

        .nav a {
            text-decoration: none;
            color: var(--primary-600);
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        input,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: var(--primary-600);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #F3F4F6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav">
            <a href="/">‚Üê Back to Dashboard</a>
        </div>
        <h1>Your Master Profile</h1>
        <p class="subtitle">Update your professional details manually or auto-fill by uploading your resume.</p>

        <!-- Resume Quick Start -->
        <div
            style="background: #EEF2FF; padding: 2rem; border-radius: 1rem; border: 2px dashed #C7D2FE; margin-bottom: 3rem; text-align: center;">
            <div style="font-weight: 700; color: #4338CA; margin-bottom: 0.5rem; font-size: 1.1rem;">‚ö° Quick Start</div>
            <p style="color: #6366F1; font-size: 0.9rem; margin-bottom: 1.5rem;">Upload your current PDF or Word resume
                to automatically extract your experience and skills using AI.</p>
            <input type="file" id="resumeUpload" style="display: none;" accept=".pdf,.doc,.docx">
            <button type="button" class="btn" onclick="document.getElementById('resumeUpload').click()" id="uploadBtn">
                <svg style="width: 1.25rem; height: 1.25rem; vertical-align: middle; margin-right: 0.5rem;" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                Upload & Parse Resume
            </button>
            <div id="uploadStatus" style="margin-top: 1rem; font-size: 0.85rem; font-weight: 500;"></div>
        </div>

        <form id="profileForm">
            <div class="section-title">Personal Information</div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="name" id="name"
                    value="{{ profile.personal_info.name if profile.personal_info else '' }}" placeholder="John Doe">
            </div>

            <div class="section-title">LinkedIn Integration</div>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Connect your LinkedIn profile to sync
                professional data.</p>
            <div class="form-group">
                <label>LinkedIn Profile URL</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="url" name="linkedin_url" id="linkedin_url" value="{{ user.linkedin_url or '' }}"
                        placeholder="https://www.linkedin.com/in/username">
                    <button type="button" class="btn" style="white-space: nowrap; width: auto; padding: 0 1rem;"
                        onclick="openLinkedInModal()">Sync Profile</button>
                </div>
            </div>

            <div class="section-title">Contact & Location</div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" id="email"
                    value="{{ profile.personal_info.email if profile.personal_info else '' }}"
                    placeholder="john@example.com">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" name="phone" id="phone"
                    value="{{ profile.personal_info.phone if profile.personal_info else '' }}"
                    placeholder="+1 234 567 890">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" name="location" id="location"
                    value="{{ profile.personal_info.location if profile.personal_info else '' }}"
                    placeholder="New York, NY">
            </div>

            <div class="section-title">Professional Summary</div>
            <div class="form-group">
                <label>Bio / Summary</label>
                <textarea name="summary" id="summary"
                    placeholder="Experienced Software Engineer with a passion for AI...">{{ profile.summary if profile else '' }}</textarea>
            </div>

            <div class="section-title">Experience (JSON Format)</div>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 1rem;">Paste your experience as a JSON array or
                descriptions. (Note: Simple text works too, AI will parse it).</p>
            <div class="form-group">
                <textarea name="experience" id="experience"
                    style="font-family: monospace;">{{ profile.experience | tojson(indent=2) if profile and profile.experience else '[]' }}</textarea>
            </div>

            <div class="section-title">Education (JSON Format)</div>
            <div class="form-group">
                <textarea name="education" id="education"
                    style="font-family: monospace;">{{ profile.education | tojson(indent=2) if profile and profile.education else '[]' }}</textarea>
            </div>

            <div class="section-title">Skills (Category: Skill List)</div>
            <div class="form-group">
                <textarea name="skills" id="skills"
                    style="font-family: monospace;">{{ profile.skills | tojson(indent=2) if profile and profile.skills else '{}' }}</textarea>
            </div>

            <div class="section-title">API Configuration (Required for AI)</div>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Enter your own API keys to power the AI
                Agents. These are stored securely for your account.</p>
            <div class="form-group">
                <label>DeepSeek API Key</label>
                <input type="password" name="deepseek_api_key" id="deepseek_api_key"
                    value="{{ user.deepseek_api_key or '' }}" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label>Google Gemini API Key (Optional)</label>
                <input type="password" name="google_api_key" id="google_api_key" value="{{ user.google_api_key or '' }}"
                    placeholder="AIza...">
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn" id="saveBtn">Save All Professional Details</button>
            </div>
        </form>
    </div>

    <!-- LinkedIn Sync Modal -->
    <div id="linkedinModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:2rem; border-radius:1rem; max-width:600px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 style="margin:0; font-size:1.5rem;">Sync LinkedIn Profile</h2>
                <button type="button" onclick="closeLinkedInModal()"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <p style="font-size:0.9rem; color:#666; margin-bottom:1.5rem;">
                Due to LinkedIn's privacy restrictions, we use <strong>AI Parsing</strong> for the best accuracy.
                <br><br>
                1. Open your <a id="linkedinLink" href="#" target="_blank"
                    style="color:#4F46E5; font-weight:600;">LinkedIn Profile</a>.
                <br>2. Press <strong>Ctrl+A</strong> (Select All) and <strong>Ctrl+C</strong> (Copy).
                <br>3. Paste the content into the box below and click <strong>Extract with AI</strong>.
            </p>
            <textarea id="linkedinText"
                style="width:100%; height:200px; padding:1rem; border:1px solid #E5E7EB; border-radius:0.5rem; font-size:0.85rem; margin-bottom:1rem;"
                placeholder="Paste profile content here..."></button>
            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button type="button" class="btn" style="background:#F3F4F6; color:#374151;" onclick="closeLinkedInModal()">Cancel</button>
                <button type="button" class="btn" id="linkedinParseBtn" onclick="parseLinkedIn()">Extract with AI Agent</button>
            </div>
        </div>
    </div>

    <script>
        function openLinkedInModal() {
            const url = document.getElementById('linkedin_url').value;
            if (!url) {
                alert('Please enter your LinkedIn URL first.');
                return;
            }
            document.getElementById('linkedinLink').href = url;
            document.getElementById('linkedinModal').style.display = 'flex';
        }

        function closeLinkedInModal() {
            document.getElementById('linkedinModal').style.display = 'none';
        }

        async function parseLinkedIn() {
            const text = document.getElementById('linkedinText').value.trim();
            if (!text) {
                alert('Please paste some content first.');
                return;
            }

            const btn = document.getElementById('linkedinParseBtn');
            btn.disabled = true;
            btn.textContent = 'AI Agent is Parsing...';

            try {
                const response = await fetch('/api/profile/linkedin/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const result = await response.json();
                if (result.success) {
                    alert('LinkedIn profile successfully parsed and synced! üöÄ');
                    window.location.reload(); // Reload to show new values
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Network error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Extract with AI Agent';
            }
        }

        // Resume Upload Handler
        document.getElementById('resumeUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const status = document.getElementById('uploadStatus');

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Analyzing with AI...';
            status.textContent = '‚è≥ Reading document and extracting data...';
            status.style.color = '#4338CA';

            const formData = new FormData();
            formData.append('resume', file);

            try {
                const response = await fetch('/api/resume/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    status.textContent = '‚úÖ Success! Data extracted. Refreshing form...';
                    status.style.color = '#059669';

                    // Update form fields with extracted data
                    const p = result.profile;
                    if (p.personal_info) {
                        document.getElementById('name').value = p.personal_info.name || '';
                        document.getElementById('email').value = p.personal_info.email || '';
                        document.getElementById('phone').value = p.personal_info.phone || '';
                        document.getElementById('location').value = p.personal_info.location || '';
                    }
                    if (p.summary) document.getElementById('summary').value = p.summary;
                    if (p.experience) document.getElementById('experience').value = JSON.stringify(p.experience, null, 2);
                    if (p.education) document.getElementById('education').value = JSON.stringify(p.education, null, 2);
                    if (p.skills) document.getElementById('skills').value = JSON.stringify(p.skills, null, 2);

                    setTimeout(() => { status.textContent = ''; }, 3000);
                } else {
                    status.textContent = '‚ùå Failed: ' + result.error;
                    status.style.color = '#DC2626';
                }
            } catch (err) {
                status.textContent = '‚ùå Network error: ' + err.message;
                status.style.color = '#DC2626';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `
                    <svg style="width: 1.25rem; height: 1.25rem; vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Upload & Parse Resume
                `;
            }
        });

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving everything...';

            try {
                // Construct the profile object
                const profile = {
                    personal_info: {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        location: document.getElementById('location').value
                    },
                    summary: document.getElementById('summary').value,
                    experience: JSON.parse(document.getElementById('experience').value || '[]'),
                    education: JSON.parse(document.getElementById('education').value || '[]'),
                    skills: JSON.parse(document.getElementById('skills').value || '{}')
                };

                const response = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        profile,
                        deepseek_api_key: document.getElementById('deepseek_api_key').value,
                        google_api_key: document.getElementById('google_api_key').value
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Profile and API Keys updated! üöÄ');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Invalid JSON in Experience/Education/Skills fields: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save All Professional Details';
            }
        });
    </script>
</body>

</html>